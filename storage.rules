rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // --- Public read access for shared assets ---
    // Logos, service images, etc., are publicly readable.
    match /{folder}/{allPaths=**} {
      allow read: if folder in ['logos', 'services', 'categories'];
    }

    // --- Rules for Authenticated Admin/Employee Users ---
    // Authenticated users can read any file within their business scope
    // and write any file as long as they provide the correct businessId in metadata.
    match /{businessId}/{allPaths=**} {
      // READ access if the user's custom claim businessId matches the file's metadata businessId.
      allow read: if request.auth != null && request.auth.token.businessId == businessId;

      // WRITE access (create, update, delete) if the user is authenticated
      // AND the new file's metadata contains a businessId that matches the user's businessId.
      allow write: if request.auth != null && request.resource.metadata.businessId == request.auth.token.businessId;
    }
    
    // --- Future-proofing for Client-specific access ---
    // Example rule for files under a client's folder.
    // Clients could access their own files if their UID matches the clientId in the path.
    match /{businessId}/clients/{clientId}/{allPaths=**} {
        allow read, write: if request.auth != null && request.auth.uid == clientId;
    }

    // --- Fallback ---
    // Disallow any other access by default.
  }
}
